-- Kubeconfig content kolonu ekle
ALTER TABLE clusters 
ADD COLUMN kubeconfig_content TEXT;

-- Kubeconfig path nullable yap (opsiyonel, geriye dönük uyumluluk için)
ALTER TABLE clusters 
ALTER COLUMN kubeconfig_path DROP NOT NULL;




- Kubeconfig content kolonu ekle
ALTER TABLE storage_clusters 
ADD COLUMN kubeconfig_content TEXT;

-- Kubeconfig path nullable yap (opsiyonel)
ALTER TABLE storage_clusters 
ALTER COLUMN kubeconfig_path DROP NOT NULL;



CREATE TABLE control_plane_cluster (
    id SERIAL PRIMARY KEY,
    kubeconfig_content TEXT NOT NULL,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_by VARCHAR(255)
);

-- Tek kayıt için constraint (opsiyonel - sadece bir kayıt olmasını garanti eder)
-- Bu constraint'i eklemek istersen:
-- ALTER TABLE control_plane_cluster ADD CONSTRAINT single_control_plane CHECK (id = 1);



CREATE TABLE tls_certificates (
    id SERIAL PRIMARY KEY,
    certificate_name VARCHAR(255) NOT NULL UNIQUE,
    certificate_content TEXT NOT NULL, -- Base64 encoded
    key_content TEXT NOT NULL, -- Base64 encoded
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_by VARCHAR(255)
);

-- Index ekle
CREATE INDEX idx_tls_cert_name ON tls_certificates(certificate_name);


   
   
   
4.1 Kubeconfig Kontrolü
-- Kaç cluster'ın kubeconfig_content'i var?
SELECT COUNT(*) FROM clusters WHERE kubeconfig_content IS NOT NULL;

-- Kaç cluster'ın kubeconfig_content'i yok?
SELECT COUNT(*) FROM clusters WHERE kubeconfig_content IS NULL;

-- Storage clusters kontrolü
SELECT COUNT(*) FROM storage_clusters WHERE kubeconfig_content IS NOT NULL;

-- Control plane kontrolü
SELECT COUNT(*) FROM control_plane_cluster;


-- TLS certificate'ları listele
SELECT certificate_name, updated_at, updated_by FROM tls_certificates;

-- Default certificate var mı?
SELECT COUNT(*) FROM tls_certificates WHERE certificate_name = 'default';


